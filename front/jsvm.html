<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PineVM - 金融时序计算模拟器</title>
    <!-- 引入 ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --panel-bg: #ffffff;
            --text-color: #212529;
            --primary-color: #0d6efd;
            --border-color: #dee2e6;
            --code-bg: #e9ecef;
            --success-color: #198754;
            --error-color: #dc3545;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: var(--primary-color);
        }
        h1 small {
            display: block;
            font-size: 0.5em;
            color: #6c757d;
            font-weight: normal;
        }
        .main-container {
            display: flex;
            gap: 20px;
            flex: 1;
        }
        .panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .control-panel { flex: 1; }
        .vm-state-panel { flex: 1.2; }
        .result-panel { flex: 2; }

        h2 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-top: 0;
        }
        textarea {
            width: calc(100% - 20px);
            height: 300px;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            resize: vertical;
        }
        .buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            background-color: var(--primary-color);
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0b5ed7;
        }
        button.secondary {
            background-color: #6c757d;
        }
        button.secondary:hover {
            background-color: #5c636a;
        }

        .code-block {
            background-color: var(--code-bg);
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            font-family: "Courier New", Courier, monospace;
            font-size: 13px;
            white-space: pre;
        }
        .log-panel {
            flex-grow: 1;
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 4px;
            font-family: "Courier New", Courier, monospace;
            font-size: 12px;
            overflow-y: auto;
            height: 150px;
            margin-top: 15px;
        }
        #chart-container {
            width: 100%;
            height: 500px;
            margin-bottom: 20px;
        }
        .table-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            text-align: left;
            font-size: 13px;
        }
        thead th {
            background-color: #e9ecef;
            position: sticky;
            top: 0;
        }

        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>PineVM - 金融时序计算模拟器
            <small>基于C++虚拟机设计的指令序列在线执行与可视化工具</small>
        </h1>
    </header>

    <div class="main-container">
        <!-- 控制面板 -->
        <section class="panel control-panel">
            <h2>1. 控制面板</h2>
            <label for="dataSource">数据源 (内置):</label>
            <select id="dataSource" style="padding: 5px; margin-top: 5px; margin-bottom: 15px;">
                <option value="AAPL">AAPL 日线数据 (2023-01-01 to 2023-06-30)</option>
            </select>
            
            <label for="instructionInput">指令序列输入 (类汇编语言):</label>
            <textarea id="instructionInput"></textarea>
            
            <div class="buttons">
                <button id="runButton">执行计算</button>
                <button id="resetButton" class="secondary">重置示例</button>
            </div>
            
            <div style="margin-top: 20px; font-size: 13px; color: #6c757d;">
                <p><strong>说明:</strong></p>
                <ul>
                    <li>每一行是一条指令，格式为 `OpCode [Operand]`。</li>
                    <li>操作数 (Operand) 可以是常量池索引、全局变量槽位索引或内置函数/变量索引。</li>
                    <li>这是对后台 C++ 结构的模拟。点击 "执行计算" 查看中间表示和最终结果。</li>
                </ul>
            </div>
        </section>

        <!-- 虚拟机状态 -->
        <section class="panel vm-state-panel">
            <h2>2. 虚拟机状态</h2>
            <p style="font-size: 13px; margin-top: -10px; color: #6c757d;">
                这里展示了输入指令被解析成的 <strong>Bytecode</strong> 结构。
            </p>
            <div id="bytecodeView" class="code-block">请先输入指令并执行...</div>

            <h3 style="margin-top: 20px;">执行日志</h3>
            <div id="logPanel" class="log-panel"></div>
        </section>

        <!-- 计算结果 -->
        <section class="panel result-panel">
            <h2>3. 计算结果</h2>
            <div id="chart-container"></div>
            <h3>输出数据</h3>
            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>Bar Index</th>
                            <th>Date</th>
                            <th>Close</th>
                            <th>MACD</th>
                            <th>Signal</th>
                            <th>Hist</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody">
                    </tbody>
                </table>
            </div>
        </section>
    </div>

<script>
// --- 数据定义 ---

// 模拟AAPL日线数据 (日期, 开,高,低,收)
const aaplData = [
    ["2023-01-03", 130.28, 130.9, 124.17, 125.07], ["2023-01-04", 126.89, 128.66, 125.08, 126.36],
    ["2023-01-05", 127.13, 127.77, 124.76, 125.02], ["2023-01-06", 126.01, 130.29, 124.89, 129.62],
    ["2023-01-09", 130.47, 133.41, 129.89, 130.15], ["2023-01-10", 130.26, 131.26, 128.12, 130.73],
    ["2023-01-11", 131.25, 133.51, 130.46, 133.49], ["2023-01-12", 133.88, 134.26, 131.41, 133.41],
    ["2023-01-13", 132.03, 134.92, 131.66, 134.76], ["2023-01-17", 134.83, 137.29, 134.13, 135.94],
    ["2023-01-18", 136.82, 138.61, 135.03, 135.21], ["2023-01-19", 134.08, 136.25, 133.77, 135.27],
    ["2023-01-20", 135.28, 138.02, 134.22, 137.87], ["2023-01-23", 138.12, 143.32, 137.9, 141.11],
    ["2023-01-24", 140.31, 142.8, 140.3, 142.53], ["2023-01-25", 140.89, 142.43, 138.81, 141.86],
    ["2023-01-26", 143.17, 144.25, 141.9, 143.96], ["2023-01-27", 143.16, 147.23, 143.08, 145.93],
    ["2023-01-30", 144.96, 145.55, 142.85, 143.0], ["2023-01-31", 142.7, 144.34, 142.28, 144.29],
    ["2023-02-01", 143.97, 146.61, 141.32, 145.43], ["2023-02-02", 148.9, 151.18, 148.17, 150.82],
    ["2023-02-03", 148.03, 157.38, 147.83, 154.5], ["2023-02-06", 152.58, 153.1, 150.78, 151.73],
    ["2023-02-07", 150.64, 155.23, 150.64, 154.65], ["2023-02-08", 153.91, 154.58, 151.17, 151.92],
    ["2023-02-09", 153.78, 154.33, 150.42, 150.87], ["2023-02-10", 149.46, 151.34, 149.22, 150.86],
    ["2023-02-13", 150.95, 154.26, 150.92, 153.85], ["2023-02-14", 152.12, 153.77, 150.86, 153.2],
    ["2023-02-15", 153.11, 155.5, 152.88, 155.33], ["2023-02-16", 153.51, 156.33, 153.35, 153.71],
    ["2023-02-17", 152.35, 152.68, 150.94, 152.55], ["2023-02-21", 150.2, 151.3, 148.41, 148.48],
    ["2023-02-22", 148.87, 149.95, 147.16, 148.91], ["2023-02-23", 149.26, 150.09, 147.24, 149.39],
    ["2023-02-24", 147.11, 147.19, 145.72, 146.71], ["2023-02-27", 147.71, 149.17, 147.45, 147.92],
    ["2023-02-28", 147.05, 149.08, 146.83, 147.41], ["2023-03-01", 146.83, 147.22, 145.01, 145.31],
    ["2023-03-02", 144.38, 146.71, 143.9, 145.91], ["2023-03-03", 148.04, 151.11, 147.33, 151.03],
    ["2023-03-06", 151.15, 156.3, 150.84, 153.83], ["2023-03-07", 153.7, 154.03, 151.13, 151.6],
    ["2023-03-08", 152.81, 153.47, 151.83, 152.87], ["2023-03-09", 153.56, 154.54, 150.23, 150.59],
    ["2023-03-10", 149.22, 149.95, 147.61, 148.5], ["2023-03-13", 147.81, 153.14, 147.7, 150.47],
    ["2023-03-14", 151.28, 153.4, 150.1, 152.59], ["2023-03-15", 151.19, 153.25, 149.92, 152.99],
    ["2023-03-16", 153.16, 156.46, 153.07, 155.85], ["2023-03-17", 156.08, 156.74, 154.28, 155.0],
    ["2023-03-20", 155.07, 155.57, 152.86, 155.4], ["2023-03-21", 157.32, 159.4, 156.54, 159.28],
    ["2023-03-22", 159.3, 162.14, 157.82, 157.83], ["2023-03-23", 158.83, 161.55, 157.68, 158.93],
    ["2023-03-24", 158.86, 160.34, 157.85, 160.25], ["2023-03-27", 159.94, 160.77, 157.87, 158.28],
    ["2023-03-28", 157.97, 158.49, 155.95, 156.39], ["2023-03-29", 159.37, 161.05, 159.35, 160.77],
    ["2023-03-30", 161.53, 162.47, 161.27, 162.36], ["2023-03-31", 162.44, 165.0, 161.91, 164.9],
    ["2023-04-03", 164.27, 166.3, 164.22, 166.17], ["2023-04-04", 166.6, 166.84, 165.11, 165.63],
    ["2023-04-05", 164.74, 165.05, 161.8, 163.76], ["2023-04-06", 162.43, 164.96, 162.0, 164.66],
    ["2023-04-10", 161.42, 162.03, 160.08, 162.03], ["2023-04-11", 162.35, 162.36, 160.51, 160.8],
    ["2023-04-12", 161.22, 162.06, 159.78, 160.1], ["2023-04-13", 161.63, 165.8, 161.42, 165.56],
    ["2023-04-14", 164.59, 166.32, 163.82, 165.21], ["2023-04-17", 165.09, 165.39, 164.03, 165.23],
    ["2023-04-18", 166.1, 167.41, 165.68, 166.47], ["2023-04-19", 165.54, 168.16, 165.54, 167.63],
    ["2023-04-20", 166.09, 167.87, 165.56, 166.65], ["2023-04-21", 165.05, 166.45, 164.49, 165.02],
    ["2023-04-24", 164.65, 165.6, 163.89, 165.33], ["2023-04-25", 165.19, 166.31, 163.73, 163.77],
    ["2023-04-26", 163.06, 165.28, 162.8, 163.76], ["2023-04-27", 165.19, 168.56, 165.19, 168.41],
    ["2023-04-28", 168.49, 169.85, 167.88, 169.68], ["2023-05-01", 169.28, 170.45, 168.64, 169.59],
    ["2023-05-02", 170.09, 170.35, 167.54, 168.54], ["2023-05-03", 169.5, 170.92, 167.16, 167.45],
    ["2023-05-04", 164.89, 167.04, 164.31, 165.79], ["2023-05-05", 170.98, 174.3, 170.76, 173.57],
    ["2023-05-08", 172.48, 173.85, 172.11, 173.5], ["2023-05-09", 173.05, 173.54, 171.6, 171.77],
    ["2023-05-10", 173.02, 174.03, 171.9, 173.56], ["2023-05-11", 173.85, 174.59, 172.17, 173.75],
    ["2023-05-12", 173.62, 174.06, 171.0, 172.57], ["2023-05-15", 173.16, 173.21, 171.47, 172.07],
    ["2023-05-16", 171.99, 173.14, 171.8, 172.07], ["2023-05-17", 171.79, 172.93, 170.42, 172.69],
    ["2023-05-18", 173.0, 175.24, 172.58, 175.05], ["2023-05-19", 176.39, 176.39, 174.94, 175.16],
    ["2023-05-22", 173.98, 174.71, 173.45, 174.2], ["2023-05-23", 173.13, 173.38, 171.28, 171.56],
    ["2023-05-24", 171.09, 172.23, 170.52, 171.84], ["2023-05-25", 172.41, 173.86, 171.69, 172.99],
    ["2023-05-26", 173.32, 175.77, 173.11, 175.43], ["2023-05-30", 176.96, 178.99, 176.82, 177.3],
    ["2023-05-31", 177.33, 179.35, 176.76, 177.25], ["2023-06-01", 177.7, 180.12, 176.93, 180.09],
    ["2023-06-02", 180.73, 181.76, 179.25, 180.95], ["2023-06-05", 182.63, 184.95, 178.04, 179.58],
    ["2023-06-06", 179.97, 180.12, 177.42, 179.21], ["2023-06-07", 178.44, 181.21, 177.32, 177.82],
    ["2023-06-08", 177.9, 180.84, 177.46, 180.57], ["2023-06-09", 181.5, 182.23, 180.63, 180.96],
    ["2023-06-12", 181.26, 183.89, 180.97, 183.79], ["2023-06-13", 182.8, 184.15, 182.44, 183.31],
    ["2023-06-14", 183.37, 184.39, 182.01, 183.95], ["2023-06-15", 183.96, 186.52, 183.78, 186.01],
    ["2023-06-16", 186.73, 186.99, 185.23, 186.13], ["2023-06-20", 184.41, 186.1, 184.41, 185.01],
    ["2023-06-21", 184.9, 185.42, 182.59, 183.96], ["2023-06-22", 183.74, 187.05, 183.67, 187.0],
    ["2023-06-23", 185.55, 187.56, 185.01, 186.68], ["2023-06-26", 186.83, 188.05, 185.23, 185.27],
    ["2023-06-27", 185.89, 188.39, 185.67, 188.06], ["2023-06-28", 187.93, 189.9, 187.64, 189.25],
    ["2023-06-29", 189.08, 190.07, 188.94, 189.59], ["2023-06-30", 191.63, 194.48, 191.26, 193.97]
];

// 默认指令序列：计算MACD
const defaultInstructions = `# MACD 指标计算示例 (12, 26, 9)
#
# 指令格式: OpCode [Operand]
# - OpCode: 操作码 (见C++ enum)
# - Operand: 操作数 (通常是池索引)
#
# 字节码结构:
# constant_pool: [12.0, 26.0, 9.0]
# global_name_pool: ["fast_ema", "slow_ema", "macd", "signal", "hist"]
# builtin_vars: ["close"]
# builtin_funcs: ["ta.ema"]

# 1. 计算快线 fast_ema = ema(close, 12)
LOAD_BUILTIN_VAR 0      # 加载 'close' 序列 (索引0)
PUSH_CONST 0            # 将 12.0 (常量池索引0) 压栈
CALL_BUILTIN_FUNC 0     # 调用 'ta.ema' (内置函数索引0)
STORE_GLOBAL 0          # 结果存入全局变量 'fast_ema' (槽位0)

# 2. 计算慢线 slow_ema = ema(close, 26)
LOAD_BUILTIN_VAR 0
PUSH_CONST 1
CALL_BUILTIN_FUNC 0
STORE_GLOBAL 1          # 存入全局变量 'slow_ema' (槽位1)

# 3. 计算 MACD (DIF) = fast_ema - slow_ema
LOAD_GLOBAL 0           # 加载 'fast_ema'
LOAD_GLOBAL 1           # 加载 'slow_ema'
SUB                     # 栈顶相减
STORE_AND_PLOT_GLOBAL 2 # 存入全局 'macd' (槽位2) 并标记为绘图

# 4. 计算 Signal 线 = ema(macd, 9)
LOAD_GLOBAL 2           # 加载 'macd'
PUSH_CONST 2            # 将 9.0 (常量池索引2) 压栈
CALL_BUILTIN_FUNC 0
STORE_AND_PLOT_GLOBAL 3 # 存入全局 'signal' (槽位3) 并标记为绘图

# 5. 计算 Histogram = macd - signal
LOAD_GLOBAL 2           # 加载 'macd'
LOAD_GLOBAL 3           # 加载 'signal'
SUB
STORE_AND_PLOT_GLOBAL 4 # 存入全局 'hist' (槽位4) 并标记为绘图

HALT`;

// --- DOM 元素 ---
const instructionInput = document.getElementById('instructionInput');
const runButton = document.getElementById('runButton');
const resetButton = document.getElementById('resetButton');
const bytecodeView = document.getElementById('bytecodeView');
const logPanel = document.getElementById('logPanel');
const chartContainer = document.getElementById('chart-container');
const resultTableBody = document.getElementById('resultTableBody');

// --- 主逻辑 ---

// 初始化 ECharts 实例
const myChart = echarts.init(chartContainer);

// 日志记录
function log(message, type = 'info') {
    const p = document.createElement('p');
    p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    if (type === 'error') p.style.color = 'var(--error-color)';
    if (type === 'success') p.style.color = 'var(--success-color)';
    logPanel.appendChild(p);
    logPanel.scrollTop = logPanel.scrollHeight;
}

// 解析文本指令为 Bytecode 对象
function parseInstructions(text) {
    const bytecode = {
        instructions: [],
        constant_pool: [],
        global_name_pool: [],
    };
    const constMap = new Map();
    const globalNameMap = new Map();

    const lines = text.split('\n');
    for (const line of lines) {
        const trimmedLine = line.trim();
        if (trimmedLine.startsWith('#') || trimmedLine === '') continue;

        const parts = trimmedLine.split(/\s+/);
        const op = parts[0].toUpperCase();
        let operand = parts.length > 1 ? parts[1] : null;
        
        const instruction = { op };
        
        // 智能处理操作数
        if (operand !== null) {
            // 根据 OpCode 判断操作数类型
            if (op === 'PUSH_CONST') {
                if (!constMap.has(operand)) {
                    constMap.set(operand, bytecode.constant_pool.length);
                    bytecode.constant_pool.push(parseFloat(operand));
                }
                instruction.operand = constMap.get(operand);
            } else if (op.startsWith('STORE_') || op.startsWith('LOAD_GLOBAL')) {
                 if (!globalNameMap.has(operand)) {
                    globalNameMap.set(operand, bytecode.global_name_pool.length);
                    bytecode.global_name_pool.push(operand);
                }
                instruction.operand = globalNameMap.get(operand);
            } else {
                instruction.operand = parseInt(operand, 10);
            }
        }
        bytecode.instructions.push(instruction);
    }
    return bytecode;
}

// 渲染 Bytecode 结构
function renderBytecode(bytecode) {
    let html = `<strong>// 指令 (Instructions)</strong>\n`;
    html += bytecode.instructions.map((inst, i) => `${i.toString().padStart(2, '0')}: ${inst.op.padEnd(20, ' ')} ${inst.operand ?? ''}`).join('\n');
    html += `\n\n<strong>// 常量池 (Constant Pool)</strong>\n`;
    html += bytecode.constant_pool.map((c, i) => `[${i}]: ${c}`).join('\n');
    html += `\n\n<strong>// 全局变量名 (Global Name Pool)</strong>\n`;
    html += bytecode.global_name_pool.map((g, i) => `[${i}]: "${g}"`).join('\n');
    bytecodeView.textContent = html;
}

// --- Function to be Replaced 1 ---
// calculateEMA, refined for more standard behavior
function calculateEMA(seriesData, period) {
    const emaData = new Array(seriesData.length).fill(NaN);
    if (seriesData.length < period) {
        // Not enough data to calculate even the first SMA
        return emaData;
    }

    const multiplier = 2 / (period + 1);

    // 1. Calculate the initial SMA for the first 'period' bars to seed the EMA
    let sum = 0;
    for (let i = 0; i < period; i++) {
        sum += seriesData[i];
    }
    emaData[period - 1] = sum / period;

    // 2. Calculate the rest of the EMA values recursively
    for (let i = period; i < seriesData.length; i++) {
        const value = seriesData[i];
        const prevEma = emaData[i - 1];
        
        if (isNaN(value) || isNaN(prevEma)) {
             emaData[i] = NaN;
             continue;
        }
        
        emaData[i] = (value - prevEma) * multiplier + prevEma;
    }
    return emaData;
}

// execute, with the corrected single-pass execution model
function execute(bytecode, marketData) {
    log('开始执行虚拟机...');

    const builtInVars = [
        { name: 'close', data: marketData.map(d => d[4]) } // 'close' is the 4th element
    ];
    const builtInFuncs = [
        (series, length) => { // ta.ema
            if (typeof series !== 'object' || !series.data || typeof length !== 'number') {
                throw new Error("ta.ema 参数错误: 需要一个序列和一个长度值。");
            }
            const emaData = calculateEMA(series.data, length);
            // Return a new series object
            return { name: `ema(${series.name}, ${length})`, data: emaData };
        }
    ];

    const globals = new Array(bytecode.global_name_pool.length).fill(null);
    const plots = [];
    
    // The VM runs the instructions only ONCE
    const stack = [];
    let pc = 0;

    while (pc < bytecode.instructions.length) {
        const instr = bytecode.instructions[pc];
        pc++; // Increment program counter immediately

        switch (instr.op) {
            case 'HALT':
                pc = bytecode.instructions.length; // End execution
                break;
            case 'PUSH_CONST':
                stack.push(bytecode.constant_pool[instr.operand]);
                break;
            case 'POP':
                stack.pop();
                break;
            case 'ADD':
            case 'SUB':
            case 'MUL':
            case 'DIV': {
                const b = stack.pop();
                const a = stack.pop();
                
                // This logic correctly handles series-to-series math
                if ((typeof a === 'object' && a.data) && (typeof b === 'object' && b.data)) {
                    const newData = a.data.map((valA, i) => {
                       const valB = b.data[i];
                       if (isNaN(valA) || isNaN(valB)) return NaN;
                       if(instr.op === 'ADD') return valA + valB;
                       if(instr.op === 'SUB') return valA - valB;
                       if(instr.op === 'MUL') return valA * valB;
                       if(instr.op === 'DIV') return valB !== 0 ? valA / valB : NaN;
                       return NaN;
                    });
                    stack.push({ name: 'calc_result', data: newData });
                } else {
                    // Scalar math (not used in this example, but good to have)
                    let res;
                    if(instr.op === 'ADD') res = a + b;
                    if(instr.op === 'SUB') res = a - b;
                    if(instr.op === 'MUL') res = a * b;
                    if(instr.op === 'DIV') res = a / b;
                    stack.push(res);
                }
                break;
            }
            case 'LOAD_BUILTIN_VAR':
                stack.push(builtInVars[instr.operand]);
                break;
            case 'LOAD_GLOBAL':
                if (!globals[instr.operand]) {
                    throw new Error(`VM Error: Attempted to load uninitialized global variable at slot ${instr.operand} (${bytecode.global_name_pool[instr.operand]})`);
                }
                stack.push(globals[instr.operand]);
                break;
            case 'STORE_GLOBAL': {
                const value = stack[stack.length - 1]; // Peek at the value, don't pop
                globals[instr.operand] = value;
                if (value && value.data) { // It's a Series
                   value.name = bytecode.global_name_pool[instr.operand];
                }
                stack.pop(); // Now pop the value
                break;
            }
            case 'STORE_AND_PLOT_GLOBAL': {
                 const value = stack[stack.length - 1]; // Peek
                 const name = bytecode.global_name_pool[instr.operand];
                 globals[instr.operand] = value;
                 if (value && value.data) {
                   value.name = name;
                   // Ensure we don't add duplicates if script is weird
                   if (!plots.find(p => p.name === name)) {
                       plots.push(value);
                   }
                }
                stack.pop(); // Pop
                break;
            }
            case 'CALL_BUILTIN_FUNC': {
                const func = builtInFuncs[instr.operand];
                const argCount = func.length; // Get expected number of arguments
                const args = [];
                for(let i = 0; i < argCount; i++) {
                    args.push(stack.pop());
                }
                const result = func(...args.reverse()); // Call with spread operator, reverse for correct order
                stack.push(result);
                break;
            }
            default:
                log(`未知的 OpCode: ${instr.op}`, 'error');
                throw new Error(`未知的 OpCode: ${instr.op}`);
        }
    }
    
    log('虚拟机执行完毕。', 'success');
    return { globals, plots };
}

// 渲染图表
function renderChart(marketData, plots) {
    const dates = marketData.map(item => item[0]);
    const ohlc = marketData.map(item => [item[1], item[4], item[2], item[3]]); // o,c,h,l for candlestick

    const macdPlot = plots.find(p => p.name === 'macd');
    const signalPlot = plots.find(p => p.name === 'signal');
    const histPlot = plots.find(p => p.name === 'hist');
    
    if(!macdPlot || !signalPlot || !histPlot) {
        log('绘图失败：未找到名为 "macd", "signal", "hist" 的绘图序列。', 'error');
        myChart.clear();
        return;
    }
    
    const macdData = macdPlot.data;
    const signalData = signalPlot.data;
    const histData = histPlot.data;

    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' }
        },
        legend: {
            data: ['K线', 'MACD', 'Signal', 'Histogram']
        },
        grid: [
            { left: '10%', right: '8%', height: '50%' },
            { left: '10%', right: '8%', top: '65%', height: '25%' }
        ],
        xAxis: [
            {
                type: 'category',
                data: dates,
                scale: true,
                boundaryGap: false,
                axisLine: { onZero: false },
                splitLine: { show: false },
                min: 'dataMin',
                max: 'dataMax'
            },
            {
                type: 'category',
                gridIndex: 1,
                data: dates,
                scale: true,
                boundaryGap: false,
                axisLine: { onZero: false },
                axisTick: { show: false },
                splitLine: { show: false },
                axisLabel: { show: false },
                min: 'dataMin',
                max: 'dataMax'
            }
        ],
        yAxis: [
            {
                scale: true,
                splitArea: { show: true }
            },
            {
                scale: true,
                gridIndex: 1,
                splitNumber: 2,
                axisLabel: { show: false },
                axisLine: { show: false },
                axisTick: { show: false },
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            { type: 'inside', xAxisIndex: [0, 1], start: 70, end: 100 },
            { show: true, xAxisIndex: [0, 1], type: 'slider', top: '90%', start: 70, end: 100 }
        ],
        series: [
            {
                name: 'K线',
                type: 'candlestick',
                data: ohlc,
                itemStyle: {
                    color: '#ef232a',
                    color0: '#14b143',
                    borderColor: '#ef232a',
                    borderColor0: '#14b143'
                }
            },
            {
                name: 'MACD',
                type: 'line',
                data: macdData,
                xAxisIndex: 1,
                yAxisIndex: 1,
                smooth: true,
                lineStyle: { opacity: 0.8 }
            },
            {
                name: 'Signal',
                type: 'line',
                data: signalData,
                xAxisIndex: 1,
                yAxisIndex: 1,
                smooth: true,
                lineStyle: { opacity: 0.8 }
            },
            {
                name: 'Histogram',
                type: 'bar',
                data: histData,
                xAxisIndex: 1,
                yAxisIndex: 1,
                itemStyle: {
                    color: (params) => (params.value >= 0 ? '#ef232a' : '#14b143')
                }
            }
        ]
    };
    myChart.setOption(option);
    log('图表渲染完成。');
}

// 渲染数据表格
// 渲染数据表格 (已修复)
function renderTable(marketData, plots) {
    // 辅助函数，用于安全地获取绘图数据
    // 如果找不到指定的序列，则返回一个长度相同、填满NaN的数组
    const getPlotData = (plotName) => {
        const plot = plots.find(p => p.name === plotName);
        return plot ? plot.data : new Array(marketData.length).fill(NaN);
    };

    const closeData = marketData.map(d => d[4]);
    const macdData = getPlotData('macd');
    const signalData = getPlotData('signal');
    const histData = getPlotData('hist');
    
    let tableHtml = '';
    // 使用 marketData.length 作为循环基准，因为它永远是完整的
    for (let i = 0; i < marketData.length; i++) {
        // 使用 toFixed(4) 并处理 NaN 值，使其在表格中显示为 "NaN"
        const formatValue = (val) => (isNaN(val) ? 'NaN' : val.toFixed(4));

        tableHtml += `
            <tr>
                <td>${i}</td>
                <td>${marketData[i][0]}</td>
                <td>${(closeData[i] || NaN).toFixed(2)}</td>
                <td>${formatValue(macdData[i])}</td>
                <td>${formatValue(signalData[i])}</td>
                <td>${formatValue(histData[i])}</td>
            </tr>
        `;
    }
    resultTableBody.innerHTML = tableHtml;
    log('数据表格渲染完成。');
}

// 主执行函数
function main() {
    logPanel.innerHTML = '';
    log('开始处理...');

    try {
        // 1. 解析指令
        const inputText = instructionInput.value;
        const bytecode = parseInstructions(inputText);
        renderBytecode(bytecode);
        log('指令解析为 Bytecode 成功。');

        // 2. 执行虚拟机
        const { globals, plots } = execute(bytecode, aaplData);
        
        // 3. 渲染结果
        if (plots.length > 0) {
            renderChart(aaplData, plots);
            renderTable(aaplData, plots);
        } else {
            log('没有需要绘图的序列。请使用 STORE_AND_PLOT_GLOBAL。', 'error');
            myChart.clear();
            resultTableBody.innerHTML = '';
        }

    } catch (e) {
        log(`发生错误: ${e.message}`, 'error');
        console.error(e);
    }
}

// 事件监听
runButton.addEventListener('click', main);
resetButton.addEventListener('click', () => {
    instructionInput.value = defaultInstructions;
    log('已重置为默认MACD计算示例。');
});

// 页面加载时初始化
window.onload = () => {
    instructionInput.value = defaultInstructions;
    log('模拟器已就绪。请点击 "执行计算" 开始。');
    myChart.setOption({
        title: { text: '请执行计算以显示图表', left: 'center', top: 'center' },
        series: []
    });
};

</script>
</body>
</html>